pipeline {
    agent any

    environment {
        DOCKER_HOST = 'tcp://docker.oms-cicd.svc.cluster.local:2375'
        NODE_VERSION = '18'
        DOCKER_REGISTRY = 'ordermysaddle'
        IMAGE_NAME = 'omsnext'
        KUBECONFIG = '/var/jenkins_home/.kube/config'
    }

    tools {
        nodejs "${NODE_VERSION}"
        dockerTool 'Docker'
    }

    stages {
        stage('Install Dependencies') {
            steps {
                dir('nestjs') {
                    sh 'npm ci --production=false'
                    sh 'npm audit --audit-level=moderate'
                }
            }
        }

        stage('Code Quality') {
            parallel {
                stage('Lint') {
                    steps {
                        dir('nestjs') {
                            sh 'npm run lint'
                        }
                    }
                }
                stage('Type Check') {
                    steps {
                        dir('nestjs') {
                            sh 'npx tsc --noEmit'
                        }
                    }
                }
                stage('Security Audit') {
                    steps {
                        dir('nestjs') {
                            sh 'npm audit --production'
                        }
                    }
                }
            }
        }

        stage('Build Application') {
            steps {
                dir('nestjs') {
                    sh 'npm run build'
                }
            }
        }

        stage('Run Tests') {
            parallel {
                stage('Unit Tests') {
                    steps {
                        dir('nestjs') {
                            sh 'npm run test:cov'
                        }
                    }
                    post {
                        always {
                            publishTestResults testResultsPattern: 'nestjs/coverage/jest-junit.xml'
                            publishCoverage adapters: [
                                coberturaAdapter('nestjs/coverage/cobertura-coverage.xml')
                            ], sourceFileResolver: sourceFiles('STORE_LAST_BUILD')
                        }
                    }
                }
                stage('Integration Tests') {
                    steps {
                        dir('nestjs') {
                            sh 'docker-compose -f docker-compose.relational.test.yaml up -d'
                            sh 'npm run test:e2e'
                        }
                    }
                    post {
                        always {
                            dir('nestjs') {
                                sh 'docker-compose -f docker-compose.relational.test.yaml down'
                            }
                        }
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    env.IMAGE_TAG = "${env.DOCKER_REGISTRY}/${env.IMAGE_NAME}:nestjs-${env.BRANCH_NAME}-${env.BUILD_NUMBER}"
                    env.IMAGE_LATEST = "${env.DOCKER_REGISTRY}/${env.IMAGE_NAME}:nestjs-${env.BRANCH_NAME}"

                    dir('nestjs') {
                        sh "docker build -t ${env.IMAGE_TAG} -t ${env.IMAGE_LATEST} ."
                    }
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    docker.withRegistry('https://registry-1.docker.io/v2/', 'dockerhub-credentials') {
                        sh "docker push ${env.IMAGE_TAG}"
                        sh "docker push ${env.IMAGE_LATEST}"
                    }
                }
            }
        }

        stage('Deploy to Staging') {
            when { branch 'staging' }
            steps {
                script {
                    sh """
                        helm upgrade --install oms-nestjs-staging ./kube/helm/nestjs/ \\
                            --namespace oms-staging \\
                            --set image.repository=${env.DOCKER_REGISTRY}/${env.IMAGE_NAME} \\
                            --set image.tag=nestjs-${env.BRANCH_NAME}-${env.BUILD_NUMBER} \\
                            --wait --timeout=300s
                    """
                }
            }
        }

        stage('Deploy to Production') {
            when { branch 'production' }
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    input message: 'Deploy to Production?', ok: 'Deploy'
                }
                script {
                    sh """
                        helm upgrade --install oms-nestjs-production ./kube/helm/nestjs/ \\
                            --namespace oms-production \\
                            --set image.repository=${env.DOCKER_REGISTRY}/${env.IMAGE_NAME} \\
                            --set image.tag=nestjs-${env.BRANCH_NAME}-${env.BUILD_NUMBER} \\
                            --wait --timeout=300s
                    """
                }
            }
        }

        stage('Health Check') {
            when {
                anyOf {
                    branch 'staging'
                    branch 'production'
                }
            }
            steps {
                script {
                    def namespace = env.BRANCH_NAME == 'production' ? 'oms-production' : 'oms-staging'
                    def healthUrl = env.BRANCH_NAME == 'production' ?
                        'https://api.ordermysaddle.com/health' :
                        'https://api-staging.ordermysaddle.com/health'

                    sh "curl -f ${healthUrl} || exit 1"
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        success {
            slackSend channel: '#deployments',
                     color: 'good',
                     message: ":white_check_mark: NestJS deployment successful: ${env.JOB_NAME} - ${env.BUILD_NUMBER}"
        }
        failure {
            slackSend channel: '#deployments',
                     color: 'danger',
                     message: ":x: NestJS deployment failed: ${env.JOB_NAME} - ${env.BUILD_NUMBER}"
        }
    }
}