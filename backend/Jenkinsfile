pipeline {
    agent any

    environment {
        DOCKER_HOST = 'tcp://docker.oms-cicd.svc.cluster.local:2375'
        NODE_VERSION = '22'
        DOCKER_REGISTRY = 'ordermysaddle'
        IMAGE_NAME = 'omsnext'
        KUBECONFIG = '/var/jenkins_home/.kube/config'
        NVM_DIR = '/var/jenkins_home/.nvm'
    }

    stages {
        stage('Setup Node.js') {
            steps {
                sh '''
                    if [ ! -d "$NVM_DIR" ]; then
                        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
                    fi
                    . "$NVM_DIR/nvm.sh"
                    nvm install $NODE_VERSION
                    nvm use $NODE_VERSION
                    node --version
                    npm --version
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('backend') {
                    sh '''
                        . "$NVM_DIR/nvm.sh"
                        npm ci --production=false
                    '''
                }
            }
        }

        stage('Code Quality') {
            parallel {
                stage('Lint') {
                    steps {
                        dir('backend') {
                            sh '''
                                . "$NVM_DIR/nvm.sh"
                                npm run lint
                            '''
                        }
                    }
                }
                stage('Type Check') {
                    steps {
                        dir('backend') {
                            sh '''
                                . "$NVM_DIR/nvm.sh"
                                npx tsc --noEmit
                            '''
                        }
                    }
                }
                stage('Security Audit') {
                    steps {
                        dir('backend') {
                            sh '''
                                . "$NVM_DIR/nvm.sh"
                                npm audit --production || true
                            '''
                        }
                    }
                }
            }
        }

        stage('Build Application') {
            steps {
                dir('backend') {
                    sh '''
                        . "$NVM_DIR/nvm.sh"
                        npm run build
                    '''
                }
            }
        }

        stage('Run Tests') {
            parallel {
                stage('Unit Tests') {
                    steps {
                        dir('backend') {
                            sh '''
                                . "$NVM_DIR/nvm.sh"
                                npm run test:cov
                            '''
                        }
                    }
                }
                stage('Integration Tests') {
                    steps {
                        dir('backend') {
                            sh '''
                                . "$NVM_DIR/nvm.sh"
                                docker-compose -f docker-compose.relational.test.yaml up -d
                                npm run test:e2e
                            '''
                        }
                    }
                    post {
                        always {
                            dir('backend') {
                                sh 'docker-compose -f docker-compose.relational.test.yaml down || true'
                            }
                        }
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    env.IMAGE_TAG = "${env.DOCKER_REGISTRY}/${env.IMAGE_NAME}:nestjs-${env.BRANCH_NAME}-${env.BUILD_NUMBER}"
                    env.IMAGE_LATEST = "${env.DOCKER_REGISTRY}/${env.IMAGE_NAME}:nestjs-${env.BRANCH_NAME}"

                    dir('backend') {
                        sh "docker build -f Dockerfile.production -t ${env.IMAGE_TAG} -t ${env.IMAGE_LATEST} ."
                    }
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh '''
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push ${IMAGE_TAG}
                        docker push ${IMAGE_LATEST}
                        docker logout
                    '''
                }
            }
        }

        stage('Deploy to Staging') {
            when { branch 'staging' }
            steps {
                sh """
                    helm upgrade --install oms-nestjs-staging ./kube/helm/oms-nest/ \\
                        --namespace oms-staging \\
                        -f ./kube/helm/oms-nest/values-staging.yaml \\
                        --set backend.image.repository=${env.DOCKER_REGISTRY}/${env.IMAGE_NAME} \\
                        --set backend.image.tag=nestjs-${env.BRANCH_NAME}-${env.BUILD_NUMBER} \\
                        --wait --timeout=300s
                """
            }
        }

        stage('Deploy to Production') {
            when { branch 'production' }
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    input message: 'Deploy to Production?', ok: 'Deploy'
                }
                sh """
                    helm upgrade --install oms-nestjs-production ./kube/helm/oms-nest/ \\
                        --namespace oms-production \\
                        -f ./kube/helm/oms-nest/values-production.yaml \\
                        --set backend.image.repository=${env.DOCKER_REGISTRY}/${env.IMAGE_NAME} \\
                        --set backend.image.tag=nestjs-${env.BRANCH_NAME}-${env.BUILD_NUMBER} \\
                        --wait --timeout=300s
                """
            }
        }

        stage('Health Check') {
            when {
                anyOf {
                    branch 'staging'
                    branch 'production'
                }
            }
            steps {
                script {
                    def healthUrl = env.BRANCH_NAME == 'production' ?
                        'https://api-nest-production.ordermysaddle.com/api/health' :
                        'https://api-nest-staging.ordermysaddle.com/api/health'

                    sh "curl -f ${healthUrl} || exit 1"
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        success {
            slackSend channel: '#deployments',
                     color: 'good',
                     message: ":white_check_mark: NestJS deployment successful: ${env.JOB_NAME} - ${env.BUILD_NUMBER}"
        }
        failure {
            slackSend channel: '#deployments',
                     color: 'danger',
                     message: ":x: NestJS deployment failed: ${env.JOB_NAME} - ${env.BUILD_NUMBER}"
        }
    }
}
