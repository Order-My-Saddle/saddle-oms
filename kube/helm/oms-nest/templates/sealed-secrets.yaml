{{/*
  Bitnami Sealed Secrets Integration

  This template provides a SealedSecret resource that can be safely committed
  to Git. The sealed-secrets controller in the cluster decrypts it into a
  regular Kubernetes Secret at runtime.

  SETUP (one-time per cluster):
    1. Install sealed-secrets controller:
       helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets
       helm install sealed-secrets sealed-secrets/sealed-secrets \
         --namespace kube-system \
         --set-string fullnameOverride=sealed-secrets-controller

    2. Install kubeseal CLI:
       brew install kubeseal   # macOS
       # or download from https://github.com/bitnami-labs/sealed-secrets/releases

    3. Seal a secret:
       kubectl create secret generic oms-nest-secrets \
         --from-literal=DATABASE_HOST=<host> \
         --from-literal=DATABASE_PASSWORD=<pass> \
         ... \
         --dry-run=client -o yaml | \
         kubeseal --controller-name=sealed-secrets-controller \
                  --controller-namespace=kube-system \
                  --format=yaml > sealed-secret.yaml

    4. Apply the sealed secret:
       kubectl apply -f sealed-secret.yaml -n {{ .Values.global.environment }}

  The SealedSecret is cluster-scoped by default; to restrict to a namespace,
  use --scope namespace-wide when sealing.

  ROTATION:
    - Re-seal secrets whenever the controller's signing key rotates (default: 30 days)
    - Use: kubeseal --fetch-cert to get the current public key
    - Re-run the seal command with the new cert

  Required secret keys (same as secrets.yaml documentation):
    DATABASE_HOST, DATABASE_PORT, DATABASE_USERNAME, DATABASE_PASSWORD, DATABASE_NAME,
    DATABASE_SSL_ENABLED, AUTH_JWT_SECRET, AUTH_JWT_TOKEN_EXPIRES_IN,
    AUTH_REFRESH_SECRET, AUTH_REFRESH_TOKEN_EXPIRES_IN,
    REDIS_HOST, REDIS_PORT, REDIS_PASSWORD,
    MAIL_HOST, MAIL_PORT, MAIL_USER, MAIL_PASSWORD,
    MAIL_DEFAULT_EMAIL, MAIL_DEFAULT_NAME, ENCRYPTION_SECRET
*/}}
{{- if .Values.sealedSecrets.enabled }}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: {{ .Values.secrets.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "oms-nest.backend.labels" . | nindent 4 }}
  annotations:
    sealedsecrets.bitnami.com/managed: "true"
    sealedsecrets.bitnami.com/namespace-wide: "true"
spec:
  encryptedData:
    {{- range $key, $value := .Values.sealedSecrets.encryptedData }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
  template:
    metadata:
      name: {{ .Values.secrets.name }}
      namespace: {{ .Release.Namespace }}
      labels:
        {{- include "oms-nest.backend.labels" . | nindent 8 }}
    type: Opaque
{{- end }}
