<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Update Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
        input, select { padding: 5px; margin: 5px; width: 200px; }
        .form-group { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Customer Update Test Tool</h1>
    <p>Use this tool to test customer update functionality without going through the full UI.</p>

    <div class="test-section">
        <h2>Quick Test</h2>
        <button onclick="runQuickTest()">Run Quick Test</button>
        <div id="quickTestResult"></div>
    </div>

    <div class="test-section">
        <h2>Manual Customer Update Test</h2>
        <form id="customerUpdateForm">
            <div class="form-group">
                <label>Customer ID:</label>
                <input type="text" id="customerId" placeholder="Enter customer ID" required>
            </div>
            <div class="form-group">
                <label>Name:</label>
                <input type="text" id="customerName" placeholder="Customer name">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="customerEmail" placeholder="customer@example.com">
            </div>
            <div class="form-group">
                <label>Address:</label>
                <input type="text" id="customerAddress" placeholder="Street address">
            </div>
            <div class="form-group">
                <label>City:</label>
                <input type="text" id="customerCity" placeholder="City">
            </div>
            <div class="form-group">
                <label>Country:</label>
                <input type="text" id="customerCountry" placeholder="Country">
            </div>
            <div class="form-group">
                <label>State:</label>
                <input type="text" id="customerState" placeholder="State">
            </div>
            <div class="form-group">
                <label>Zipcode:</label>
                <input type="text" id="customerZipcode" placeholder="12345">
            </div>
            <div class="form-group">
                <label>Phone:</label>
                <input type="text" id="customerPhone" placeholder="555-1234">
            </div>
            <div class="form-group">
                <label>Cell:</label>
                <input type="text" id="customerCell" placeholder="555-5678">
            </div>
            <button type="submit">Update Customer</button>
        </form>
        <div id="updateResult"></div>
    </div>

    <div class="test-section">
        <h2>Test Log</h2>
        <div id="testLog"></div>
    </div>

    <script>
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testLog.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateTestLog();
        }

        function updateTestLog() {
            document.getElementById('testLog').innerHTML =
                '<pre>' + testLog.slice(-20).join('\n') + '</pre>';
        }

        function getAuthToken() {
            try {
                const stored = localStorage.getItem('auth_token');
                if (stored && stored !== 'null') {
                    return JSON.parse(stored);
                }
            } catch (e) {
                // Fallback to cookies
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'token') {
                        return value;
                    }
                }
            }
            return null;
        }

        async function updateCustomer(customerId, customerData) {
            const API_URL = 'http://localhost:8888';
            const token = getAuthToken();

            if (!token) {
                throw new Error('No authentication token found. Please log in first.');
            }

            const entity = {
                id: customerId,
                name: customerData.name,
                email: customerData.email,
                address: customerData.address,
                city: customerData.city,
                country: customerData.country,
                state: customerData.state,
                zipcode: customerData.zipcode,
                phoneNo: customerData.phoneNo,
                cellNo: customerData.cellNo,
                entityAspect: {
                    entityTypeName: "Customer:#App.Entity",
                    entityState: "Modified",
                    originalValuesMap: {},
                    autoGeneratedKey: null,
                    defaultResourceName: "customers"
                }
            };

            // Remove undefined fields
            Object.keys(entity).forEach(key => {
                if (key !== 'entityAspect' && entity[key] === undefined) {
                    delete entity[key];
                }
            });

            const saveBundle = { entities: [entity] };

            log(`Sending update request for customer ${customerId}`);
            log(`Payload: ${JSON.stringify(saveBundle, null, 2)}`);

            const response = await fetch(`${API_URL}/save`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/ld+json',
                    'Accept': 'application/ld+json',
                    'Authorization': `Bearer ${token}`,
                },
                credentials: 'include',
                body: JSON.stringify(saveBundle),
            });

            if (!response.ok) {
                const errorText = await response.text();
                log(`Response error: ${response.status} ${errorText}`, 'error');

                // Check for cache-proxy error
                try {
                    const errorData = JSON.parse(errorText);
                    if (errorData['hydra:description'] && errorData['hydra:description'].includes('cache-proxy')) {
                        log('Cache-proxy error detected - update likely succeeded', 'warning');
                        return { id: customerId, ...customerData };
                    }
                } catch (e) {
                    if (errorText.includes('cache-proxy')) {
                        log('Cache-proxy error detected - update likely succeeded', 'warning');
                        return { id: customerId, ...customerData };
                    }
                }

                throw new Error(`Failed to update customer: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();
            log(`Update successful: ${JSON.stringify(result)}`, 'success');

            if (result.Entities && result.Entities.length > 0) {
                return result.Entities[0];
            }

            return { id: customerId, ...customerData };
        }

        async function runQuickTest() {
            const resultDiv = document.getElementById('quickTestResult');
            resultDiv.className = 'test-section';
            resultDiv.innerHTML = '<p>Running quick test...</p>';

            try {
                log('Starting quick test');

                // Test with a dummy customer ID
                const testData = {
                    name: `Test Customer ${Date.now()}`,
                    email: `test-${Date.now()}@example.com`,
                    address: '123 Test Street',
                    city: 'Test City',
                    country: 'Test Country'
                };

                // You need to replace this with an actual customer ID from your database
                const testCustomerId = 'test-customer-id';

                const result = await updateCustomer(testCustomerId, testData);

                resultDiv.className = 'test-section success';
                resultDiv.innerHTML = `
                    <h3>✅ Quick Test Passed!</h3>
                    <p>Customer update functionality is working correctly.</p>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;

                log('Quick test completed successfully', 'success');

            } catch (error) {
                resultDiv.className = 'test-section error';
                resultDiv.innerHTML = `
                    <h3>❌ Quick Test Failed</h3>
                    <p>Error: ${error.message}</p>
                    <p>Check the test log for details.</p>
                `;

                log(`Quick test failed: ${error.message}`, 'error');
            }
        }

        document.getElementById('customerUpdateForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const resultDiv = document.getElementById('updateResult');
            resultDiv.className = 'test-section';
            resultDiv.innerHTML = '<p>Updating customer...</p>';

            try {
                const customerId = document.getElementById('customerId').value;
                const customerData = {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    address: document.getElementById('customerAddress').value,
                    city: document.getElementById('customerCity').value,
                    country: document.getElementById('customerCountry').value,
                    state: document.getElementById('customerState').value,
                    zipcode: document.getElementById('customerZipcode').value,
                    phoneNo: document.getElementById('customerPhone').value,
                    cellNo: document.getElementById('customerCell').value,
                };

                // Remove empty values
                Object.keys(customerData).forEach(key => {
                    if (!customerData[key]) {
                        delete customerData[key];
                    }
                });

                const result = await updateCustomer(customerId, customerData);

                resultDiv.className = 'test-section success';
                resultDiv.innerHTML = `
                    <h3>✅ Customer Updated Successfully!</h3>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;

                log(`Customer ${customerId} updated successfully`, 'success');

            } catch (error) {
                resultDiv.className = 'test-section error';
                resultDiv.innerHTML = `
                    <h3>❌ Update Failed</h3>
                    <p>Error: ${error.message}</p>
                `;

                log(`Customer update failed: ${error.message}`, 'error');
            }
        });

        // Initialize
        log('Customer Update Test Tool loaded');

        // Check authentication status
        const token = getAuthToken();
        if (token) {
            log('Authentication token found', 'success');
        } else {
            log('No authentication token found - please log in to the main application first', 'warning');
        }
    </script>
</body>
</html>